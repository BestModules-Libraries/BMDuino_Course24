/******************************************************************
檔案名稱(File):       voiceUpdateAndPlayback.ino
功能說明(Description): 音源更新與語音播放控制範例
設計說明(Note):       使用 BMV31T001 模組進行語音檔更新與播放控制
******************************************************************/

#include "BMV31T001.h" 
#include "voice_cmd_list.h"    // 包含語音指令定義的標頭檔，內含 VOC_1 ~ VOC_10 等語音代碼

//==================================================================
// 建立物件
//==================================================================
BMV31T001 myBMV31T001;         // 建立 BMV31T001 類別的物件，用來控制語音模組

//==================================================================
// 建立使用者自訂函式宣告清單
//==================================================================

void initVoice();    //初始化語音感測模組
uint8_t getBoardKey() ; //取得語音感測模組之按鍵


//==================================================================
// 建立全域變數與參數設定
//==================================================================
#define VOICE_TOTAL_NUMBER 10  // 測試語音總數為 10 組
// 從 voice_cmd_list.h 取得的語音代碼表，對應 10 段語音
const uint8_t voice_table[VOICE_TOTAL_NUMBER] = { 
    VOC_1, VOC_2, VOC_3, VOC_4, VOC_5, VOC_6, VOC_7, VOC_8, VOC_9, VOC_10
};

//==================================================================
// 宣告變數
//==================================================================
uint8_t keyStatus;             // 當前按鍵狀態 (由模組掃描結果取得)
uint8_t lastKeyStatus;         // 上一次按鍵狀態，用來判斷是否為「新按下」事件
uint8_t playStatus;            // 播放狀態 (閒置或忙碌)
uint8_t playNum;               // 當前播放的語音序號 (0~9)

#define DEFAULT_VOLUME 6       // 預設音量值 (中等音量)
uint8_t volume = DEFAULT_VOLUME; // 當前音量
uint8_t keycode = 0;           // 紀錄目前被觸發的按鍵編號
/*
  不按：0
  按下按鈕：1
  向上：2
  向下：4
  向左：8
  向右：16
*/

void initVoice()    //初始化語音感測模組
{
    myBMV31T001.begin();                       // 初始化 BMV31T001 模組 (設定通訊介面)
    myBMV31T001.setPower(BMV31T001_POWER_ENABLE); // 開啟模組電源供應

    // 若需要更新音源內容，啟動音訊更新模式
    myBMV31T001.initAudioUpdate();

    delay(100);                                // 延遲 100ms，確保模組電源穩定
    myBMV31T001.setVolume(DEFAULT_VOLUME);     // 設定初始音量為預設值
}

uint8_t getBoardKey()//取得語音感測模組之按鍵
{
  //--------------------------------------------------------------
  // 3. 掃描按鍵狀態
  //--------------------------------------------------------------
  myBMV31T001.scanKey();                     // 執行按鍵掃描
  //--------------------------------------------------------------
  // 4. 若有按鍵動作則進行對應處理
  //--------------------------------------------------------------
  if (myBMV31T001.isKeyAction() != BMV31T001_NO_KEY) 
  { 
      return myBMV31T001.readKeyValue(); // 讀取目前按鍵的值
  }
  else
  {
      return 0x00 ;
  }
}















