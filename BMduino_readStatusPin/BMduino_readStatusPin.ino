/*****************************************************************
File:         readStatusPin     
Description:  
  本程式示範如何讀取 BM22S4221-1 人感模組（PIR / mmWave）的狀態腳位，
  並依照不同狀態讓 LED 產生不同的燈號效果，藉此顯示裝置目前是否偵測到物體。

  狀態說明：
    a. 模組正常（flag = 0）：沒有偵測到移動物體、沒有入侵警示。
       → 腳位 13 的 LED 每秒閃爍一次（亮 100ms）。

    b. 模組警報（flag = 1）：偵測到物體或人員經過。
       → 腳位 13 的 LED 會持續亮起（每次亮 1 秒）。

  另外：
    當模組狀態改變（由正常 → 警報 或 警報 → 正常），
    系統會透過序列埠（Serial Monitor）印出對應訊息。
******************************************************************/

#include "BM22S4221-1.h"       // 引入 BM22S4221-1 感測模組專用函式庫

uint8_t flag;                 // 旗標變數，用來記錄目前感測器的工作狀態
                             // flag = 0 → 正常模式
                             // flag = 1 → 警報模式（偵測到物體）
                             
uint8_t STATUS = 5;           // 設定模組的「狀態腳位」，此腳位會輸出 HIGH / LOW 代表狀態

// ---- 感測器物件建立方式（只能擇一使用）--------------------------------------
// BM22S4221_1 PIR(STATUS,6,7);   // 使用軟體序列：intPin=5, rxPin=6, txPin=7
BM22S4221_1 PIR(22, &Serial1);  // 使用硬體序列 Serial1，intPin = 22（BMduino 預設支援）
// BM22S4221_1 PIR(29, &Serial2); // 使用硬體序列 Serial2
// BM22S4221_1 PIR(STATUS, &Serial3); // 使用硬體序列 Serial3
// BM22S4221_1 PIR(STATUS, &Serial4); // 使用硬體序列 Serial4
// ------------------------------------------------------------------------------

void setup() {
  Serial.begin(9600);          // 初始化序列通訊，設定鮑率為 9600，供監控輸出訊息使用

  PIR.begin();                 // 初始化 BM22S4221-1 模組（啟動串列通訊與模組設定）

  pinMode(STATUS, INPUT);      // 感測器狀態腳位設為「輸入模式」
  pinMode(13, OUTPUT);         // 內建 LED 腳位（13）設定為輸出，用於顯示狀態
}

void loop() {

  /***************************************
   * 當感測器輸出 HIGH（偵測到物體）
   * 且 flag 尚未進入警報狀態（!= 1）
   * → 則觸發警報事件
   ***************************************/
  if (PIR.getSTATUS() == HIGH && flag != 1) { 
    Serial.println("Alarm! an object passes by");  // 印出警報訊息
    flag = 1;                                      // 設定為警報狀態
  }

  /***************************************
   * 當感測器恢復 LOW（無物體）
   * 且 flag 不為 0（表示剛解除警報）
   * → 模組恢復正常
   ***************************************/
  if (flag != 0 && PIR.getSTATUS() == LOW) {
    flag = 0;                                      // 重設旗標
    Serial.println("Module normal; no alarm");     // 印出正常訊息
  }

  /***************************************
   * 根據 flag 狀態控制 LED 行為
   * case 0 → 正常模式：每 1 秒閃爍一次
   * case 1 → 警報模式：LED 長亮（每秒亮一次）
   ***************************************/
  switch (flag) {

    case 0:                                // 正常狀態（無偵測）
      digitalWrite(13, HIGH);              // LED 快速亮一下
      delay(100);                          // 亮 100ms
      digitalWrite(13, LOW);               // 熄滅
      delay(900);                          // 每秒一次週期
      break;

    case 1:                                // 警報狀態（偵測到物體）
      digitalWrite(13, HIGH);              // LED 持續亮
      delay(1000);                         // 每秒亮一次（等同長亮）
      break;
  }
}
