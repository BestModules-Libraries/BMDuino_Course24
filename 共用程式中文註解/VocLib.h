//**************************************************************
// 自訂語音控制函式模組
// 主要負責：初始化 BMV31T001 語音模組、控制播放 / 暫停 / 重複 / 音量、
//         以及提供數字念讀、溫度、濕度與一般提示語的播放介面。
//**************************************************************
/******************************************************************
設計說明(Note): 
  本模組使用 BMV31T001 語音播放模組，搭配事先寫入的語音檔，
  透過函式呼叫即可播放對應的語音內容。
******************************************************************/
//------外部引入函式區--------------------------
#include "BMV31T001.h"       // BMV31T001 語音模組驅動程式函式庫
#include "voice_cmd_list.h"  // 語音編號列表（例如 VOC_1 ~ VOC_38 等常數定義）

//-----------------感測元件物件區-------------------------
//==============================================================
// 建立 BMV31T001 語音模組物件
//==============================================================
BMV31T001 myBMV31T001;   // 宣告一個語音模組物件，用來呼叫 begin / playVoice / setPower 等方法


//==============================================================
// 全域變數宣告與設定
//==============================================================
#define VOICE_TOTAL_NUMBER 38   // 定義目前語音清單中可用的語音總數（共 38 段）

// 建立語音對應表：
//   voice_table[i] 對應到 voice_cmd_list.h 中的 VOC_xx 宏定義
//   方便以索引方式依序播放或指定某一筆語音。
const uint8_t voice_table[VOICE_TOTAL_NUMBER] = {
    VOC_1,  VOC_2,  VOC_3,  VOC_4,  VOC_5,  VOC_6,  VOC_7,  VOC_8,  VOC_9,  VOC_10,
    VOC_11, VOC_12, VOC_13, VOC_14, VOC_15, VOC_16, VOC_17, VOC_18, VOC_19, VOC_20,
    VOC_21, VOC_22, VOC_23, VOC_24, VOC_25, VOC_26, VOC_27, VOC_28, VOC_29, VOC_30,
    VOC_31, VOC_32, VOC_33, VOC_34, VOC_35, VOC_36, VOC_37, VOC_38
};

//==============================================================
// 狀態變數（紀錄模組狀態與按鍵資訊）
//==============================================================
uint8_t keyStatus;      // 當前一次掃描到的按鍵狀態
uint8_t lastKeyStatus;  // 上一次掃描到的按鍵狀態，可用於判斷「狀態改變」
uint8_t playStatus;     // 播放狀態：BMV31T001_BUSY 或 BMV31T001_NOBUSY
uint8_t playNum;        // 目前播放中的語音編號（可用來做上一首 / 下一首等功能）

// 預設音量等級（0~11，共 12 級）
#define DEFAULT_VOLUME 9
uint8_t volume = DEFAULT_VOLUME; // 目前音量設定值
uint8_t keycode = 0;             // 暫存從語音模組讀取到的按鍵代碼

/*
按鍵代碼對照表說明：
  不按：0
  中鍵：1  （Confirm / OK）
  向上：2
  向下：4
  向左：8
  向右：16
*/

//==============================================================
// 自訂函式宣告區（介面原型宣告）
//==============================================================
void initVoice();                    // 初始化語音模組
uint8_t getBoardKey();               // 從 BMV31T001 模組讀取按鍵狀態
void DisplayVoiceStatus();           // 根據播放狀態控制 LED（發亮代表正在播放）
void setVolume(uint8_t volume);      // 設定音量等級
void play(uint8_t num);              // 播放單段語音（不循環）
void playloop(uint8_t num);          // 循環播放單段語音
void playsentence(uint8_t num);      // 播放「語句」（語音模組內另一種播放模式）
void playsentenceloop(uint8_t num);  // 循環播放語句
void playstop();                     // 停止播放
void playPause();                    // 暫停播放
void playContinue();                 // 繼續播放
void playRepeat();                   // 重複播放（重播目前語音）
boolean isPlaying();                 // 回傳播放狀態（true = 正在播放）
void setVoicePower(uint8_t status);  // 開關語音模組電源
void setVoiceLed(uint8_t status);    // 控制語音模組上狀態指示燈
void saynumber(int num);             // 念出單一數字（0~9）
boolean checknum(String ss);         // 檢查字串是否為單一數字字元 (0~9)
void sayText(uint8_t num);           // 播放 voice_table 中指定索引的語音
void SpeakStringNumber(String snum); // 將一整串數字字串逐位念出（可含小數點與負號）
void SayHello();                     // 播放開頭歡迎語
void SayTemperature(String snum);    // 播放「現在溫度 + 數值 + 單位」
void SayHumidity(String snum);       // 播放「現在濕度 + 數值 + 單位」
void SayString(uint8_t vv);          // 播放一段文字（單一語音）
void SayString(uint8_t vv, uint8_t vv2); // 連續播放兩段文字（兩段語音）

// ------- 自定義函式內容程式區 -----------
//==============================================================
// 初始化語音模組
//==============================================================
void initVoice()
{
    myBMV31T001.begin();                         // 初始化 BMV31T001 模組，設定通訊介面（I2C / UART 依函式庫實作）
    myBMV31T001.setPower(BMV31T001_POWER_ENABLE);// 啟用語音模組電源
    myBMV31T001.initAudioUpdate();               // 進入音訊更新準備模式（若要透過 PC 更新語音檔，此步驟必要）
    delay(100);                                  // 延遲 100ms，讓模組穩定
    myBMV31T001.setVolume(DEFAULT_VOLUME);       // 設定預設音量等級
}

//==============================================================
// 取得按鍵值（讀取語音模組板載按鍵狀態）
//==============================================================
uint8_t getBoardKey()
{
    myBMV31T001.scanKey();  // 要先呼叫 scanKey()，模組才會更新內部按鍵狀態

    // 若有偵測到按鍵動作（非 NO_KEY），就讀取按鍵代碼
    if (myBMV31T001.isKeyAction() != BMV31T001_NO_KEY)
        return myBMV31T001.readKeyValue();  // 回傳按鍵代碼（1,2,4,8,16 或 0）
    else
        return 0x00;                        // 無按鍵按下
}

//==============================================================
// 顯示播放狀態（並同步控制 LED）
//==============================================================
void DisplayVoiceStatus()
{
    if (myBMV31T001.isPlaying() == BMV31T001_BUSY)
    {
        playStatus = BMV31T001_BUSY;              // 更新狀態變數為「忙碌中」
        myBMV31T001.setLED(BMV31T001_LED_ON);     // LED 亮，代表正在播放
    }
    else
    {
        playStatus = BMV31T001_NOBUSY;            // 狀態為「非忙碌」（閒置或停止）
        myBMV31T001.setLED(BMV31T001_LED_OFF);    // LED 滅
    }
}

//==============================================================
// 設定音量
//==============================================================
void setVolume(uint8_t volume)
{
    myBMV31T001.setVolume(volume);
    // 音量等級範圍：0 ~ 11
    // 0 表示靜音，11 為最大音量
}

//==============================================================
// 播放單段語音（一次性，不循環）
//==============================================================
void play(uint8_t num)
{
    myBMV31T001.playVoice(num, 0);
    // num：語音編號 (0~255，實際需與 Voice Widget 設定相對應)
    // 第二個參數 0：僅播放一次，不循環
}

//==============================================================
// 循環播放單段語音
//==============================================================
void playloop(uint8_t num)
{
    myBMV31T001.playVoice(num, 1);
    // 第二個參數 1：重複循環播放同一段語音
}

//==============================================================
// 播放語句（Sentence 模式）
//==============================================================
void playsentence(uint8_t num)
{
    myBMV31T001.playSentence(num, 0);
    // 依「語句模式」的索引 num 播放一次
    // 常用於將多個語音片段組合成一個句子
}

//==============================================================
// 循環播放語句
//==============================================================
void playsentenceloop(uint8_t num)
{
    myBMV31T001.playSentence(num, 1);
    // 以語句模式，重複循環播放同一個句子
}

//==============================================================
// 停止播放
//==============================================================
void playstop()
{
    myBMV31T001.playStop();  // 立即停止當前播放
}

//==============================================================
// 暫停播放
//==============================================================
void playPause()
{
    myBMV31T001.playPause(); // 將當前播放進度暫停
}

//==============================================================
// 繼續播放
//==============================================================
void playContinue()
{
    myBMV31T001.playContinue(); // 從暫停處繼續播放
}

//==============================================================
// 重複播放
//==============================================================
void playRepeat()
{
    myBMV31T001.playRepeat();   // 重新播放當前語音（從頭開始）
}

//==============================================================
// 檢查是否正在播放
//==============================================================
boolean isPlaying()
{
    // myBMV31T001.isPlaying() 內部會回傳 BMV31T001_BUSY 或 BMV31T001_NOBUSY
    return myBMV31T001.isPlaying();
}

//==============================================================
// 控制語音模組電源
//==============================================================
void setVoicePower(uint8_t status)
{
    myBMV31T001.setPower(status);
    // 傳入參數例：
    //   BMV31T001_POWER_ENABLE  = 開啟電源
    //   BMV31T001_POWER_DISABLE = 關閉電源
}

//==============================================================
// 控制語音模組上的狀態指示燈
//==============================================================
void setVoiceLed(uint8_t status)
{
    myBMV31T001.setLED(status);
    // 傳入參數例：
    //   BMV31T001_LED_ON  = LED 亮
    //   BMV31T001_LED_OFF = LED 滅
}

//==============================================================
// 播放單一數字（0~9）所對應的語音
//==============================================================
void saynumber(int num)
{
    // 如果傳入數字超出 0~9 範圍，則直接顯示錯誤訊息並返回
    if (num < 0 || num > 9)
    {
        Serial.println("Wrong Number：僅允許 0~9 數字");
        return;
    }

    // 若語音模組目前正在播放，則等待播放結束
    if (isPlaying())
        while (isPlaying());

    // 當模組處於「未播放」狀態時，開始播放對應數字語音
    while (!isPlaying())
    {
        // voice_table[num] 內存放的是對應數字的 VOC_xx 常數
        play(voice_table[num]);
    }
}

//==============================================================
// 檢查字串是否為「單一數字字元」（0~9）
//==============================================================
boolean checknum(String ss)
{
    String numberchar = "0123456789"; // 合法數字字元集合

    if (ss.length() != 1)   // 若長度不是 1，必定不是單一數字
        return false;

    // 判斷字串中唯一的字元是否存在於 numberchar 中
    if (numberchar.indexOf(ss.charAt(0)) >= 0)
        return true;  // 是 0~9 數字
    else
        return false; // 非數字
}

//==============================================================
// 播放語音表中第 num 筆的語音內容
//==============================================================
void sayText(uint8_t num)
{
    // 等待前一個語音播放完畢
    if (isPlaying())
        while (isPlaying());

    // 在模組閒置時開始播放指定語音
    while (!isPlaying())
    {
        play(voice_table[num]);  // 播放 voice_table[num] 對應的 VOC_xx
    }
}

//==============================================================
// 播放「數字字串」
//   例如 snum = "23.5" → 會依序念出：2、3、「點」、5
//   snum = "-10"   → 念出：「負」、1、0
//==============================================================
void SpeakStringNumber(String snum)
{
    if (snum.length() == 0)
        return; // 空字串不處理

    int le = snum.length();
    String cc;

    for (int i = 0; i < le; i++)
    {
        cc = snum.substring(i, i + 1); // 依序取出每一個字元

        if (checknum(cc))
        {
            // 若是 0~9，轉成 int 之後呼叫 saynumber()
            saynumber(cc.toInt());
        }
        else
        {
            // 若是非數字，額外處理小數點與負號
            if (cc == ".")
                sayText(VOC_11); // 假設 VOC_11 對應「點」
            if (cc == "-")
                sayText(VOC_12); // 假設 VOC_12 對應「負」
        }
    }
}

//==============================================================
// 播放開頭歡迎語
//==============================================================
void SayHello()
{
    setVoiceLed(1);        // 亮 LED 表示正在播放提示
    sayText(VOC_13);       // 播放「開頭文字或歡迎字」（實際內容由語音檔決定）
    setVoiceLed(0);        // 播放完畢後熄滅 LED
}

//==============================================================
// 播放溫度資訊：「現在溫度」 + 數值 + 「攝氏度」
//   snum 例： "23.5"
//==============================================================
void SayTemperature(String snum)
{
    setVoiceLed(1);          // 亮 LED

    sayText(VOC_14);         // 播放「現在溫度」或類似提示
    SpeakStringNumber(snum); // 逐位念出數字（可含小數點與負號）
    sayText(VOC_16);         // 播放「攝氏度」或單位語音

    setVoiceLed(0);          // 熄滅 LED
}

//==============================================================
// 播放濕度資訊：「現在濕度」 + 數值 + 「百分比」
//   snum 例： "65"
//==============================================================
void SayHumidity(String snum)
{
    setVoiceLed(1);          // 亮 LED

    sayText(VOC_15);         // 播放「現在濕度」或類似提示
    SpeakStringNumber(snum); // 念出數字
    sayText(VOC_17);         // 播放「百分比」或其他單位

    setVoiceLed(0);          // 熄滅 LED
}

//==============================================================
// 播放一段語音（單一語音代碼）
//==============================================================
void SayString(uint8_t vv)
{
    setVoiceLed(1);    // 播放期間 LED 亮
    sayText(vv);       // 依傳入之語音代碼（或索引）播放
    setVoiceLed(0);    // 播放完成 LED 滅
}

//==============================================================
// 連續播放二段語音（例如「前門」+「入侵警示」）
//==============================================================
void SayString(uint8_t vv, uint8_t vv2)
{
    setVoiceLed(1);    // 播放期間 LED 亮

    sayText(vv);       // 先播放第一段語音
    delay(300);        // 兩段語音之間留 0.3 秒間隔
    sayText(vv2);      // 播放第二段語音
    setVoiceLed(0);    // 播放完成 LED 滅
}


