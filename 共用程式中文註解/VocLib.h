//**************************************************************
// 自訂語音控制函式模組
//**************************************************************
/******************************************************************
設計說明(Note): 使用 BMV31T001 模組進行語音檔更新與播放控制
******************************************************************/

#include "BMV31T001.h"
#include "voice_cmd_list.h" // 包含語音指令代碼 VOC_1 ~ VOC_17

//==============================================================
// 建立物件
//==============================================================
BMV31T001 myBMV31T001; // 宣告語音播放模組物件，負責控制 BMV31T001

//==============================================================
// 自訂函式宣告區
//==============================================================
void initVoice();                   // 初始化語音模組
uint8_t getBoardKey();              // 讀取語音模組的按鍵狀態
void DisplayVoiceStatus();          // 顯示播放狀態燈號
void setVolume(uint8_t volume);     // 設定音量
void play(uint8_t num);             // 播放單段語音
void playloop(uint8_t num);         // 循環播放單段語音
void playsentence(uint8_t num);     // 播放語句
void playsentenceloop(uint8_t num); // 循環播放語句
void playstop();                    // 停止播放
void playPause();                   // 暫停播放
void playContinue();                // 繼續播放
void playRepeat();                  // 重複播放
boolean isPlaying();                // 檢查播放狀態
void setVoicePower(uint8_t status); // 控制模組電源
void setVoiceLed(uint8_t status);   // 控制狀態指示燈
void saynumber(int num);            // 播放單一數字
boolean checknum(String ss);        // 判斷輸入字串是否為數字 (0~9)
void sayText(uint8_t num);          // 播放語音清單中的語音
void SpeakStringNumber(String snum);// 念出一串數字字串
void sayTitle(uint8_t num);  //撥放語音開始公告音
void saySensor(uint8_t num,String ss,uint8_t num2);  //撥放感測模組資料語音


//==============================================================
// 全域變數宣告與設定
//==============================================================
#define VOICE_TOTAL_NUMBER 25 // 定義可播放的語音總數
// 建立語音對應表，用於依序播放
const uint8_t voice_table[VOICE_TOTAL_NUMBER] = {
    VOC_1, VOC_2, VOC_3, VOC_4, VOC_5, VOC_6, VOC_7, VOC_8, VOC_9, VOC_10,
    VOC_11, VOC_12, VOC_13, VOC_14, VOC_15, VOC_16, VOC_17, VOC_18, VOC_19
    , VOC_20, VOC_21, VOC_22, VOC_23, VOC_24, VOC_25};

//==============================================================
// 狀態變數
//==============================================================
uint8_t keyStatus;     // 當前按鍵狀態
uint8_t lastKeyStatus; // 上次按鍵狀態
uint8_t playStatus;    // 播放狀態 (忙碌/閒置)
uint8_t playNum;       // 當前播放語音編號

#define DEFAULT_VOLUME 6
uint8_t volume = DEFAULT_VOLUME; // 當前音量 (0~11)
uint8_t keycode = 0;             // 按鍵代碼暫存

/*
按鍵代碼對照表：
  不按：0
  中鍵：1
  向上：2
  向下：4
  向左：8
  向右：16
*/

//==============================================================
// 初始化語音模組
//==============================================================
void initVoice()
{
    myBMV31T001.begin();                        // 初始化 BMV31T001 通訊
    myBMV31T001.setPower(BMV31T001_POWER_ENABLE);// 開啟電源
    myBMV31T001.initAudioUpdate();              // 若需要，可進入音訊更新模式
    delay(100);                                 // 等待模組穩定
    myBMV31T001.setVolume(DEFAULT_VOLUME);      // 設定預設音量
}

//==============================================================
// 取得按鍵值
//==============================================================
uint8_t getBoardKey()
{
    myBMV31T001.scanKey(); // 執行按鍵掃描
    if (myBMV31T001.isKeyAction() != BMV31T001_NO_KEY)
        return myBMV31T001.readKeyValue(); // 若有按鍵動作，回傳按鍵代碼
    else
        return 0x00; // 無按鍵動作
}

//==============================================================
// 顯示播放狀態燈號
//==============================================================
void DisplayVoiceStatus()
{
    if (myBMV31T001.isPlaying() == BMV31T001_BUSY)
    {
        playStatus = BMV31T001_BUSY;
        myBMV31T001.setLED(BMV31T001_LED_ON); // 正在播放 → LED 亮
    }
    else
    {
        playStatus = BMV31T001_NOBUSY;
        myBMV31T001.setLED(BMV31T001_LED_OFF); // 停止播放 → LED 滅
    }
}

//==============================================================
// 設定音量
//==============================================================
void setVolume(uint8_t volume)
{
    myBMV31T001.setVolume(volume);
    // 音量範圍：0~11
    // 0 為靜音，共 12 級音量
}

//==============================================================
// 播放單段語音
//==============================================================
void play(uint8_t num)
{
    myBMV31T001.playVoice(num, 0);
    // num：語音編號
    // 第二個參數 0：不循環播放
}

//==============================================================
// 循環播放語音
//==============================================================
void playloop(uint8_t num)
{
    myBMV31T001.playVoice(num, 1);
    // 第二個參數 1：循環播放
}

//==============================================================
// 播放語句
//==============================================================
void playsentence(uint8_t num)
{
    myBMV31T001.playSentence(num, 0);
    // 播放語句，非單段語音
    // 0 表示不循環
}

//==============================================================
// 循環播放語句
//==============================================================
void playsentenceloop(uint8_t num)
{
    myBMV31T001.playSentence(num, 1);
    // 1 表示循環播放
}

//==============================================================
// 停止播放
//==============================================================
void playstop()
{
    myBMV31T001.playStop();
}

//==============================================================
// 暫停播放
//==============================================================
void playPause()
{
    myBMV31T001.playPause();
}

//==============================================================
// 繼續播放
//==============================================================
void playContinue()
{
    myBMV31T001.playContinue();
}

//==============================================================
// 重複播放
//==============================================================
void playRepeat()
{
    myBMV31T001.playRepeat();
}

//==============================================================
// 檢查是否正在播放
//==============================================================
boolean isPlaying()
{
    return myBMV31T001.isPlaying();
}

//==============================================================
// 控制電源
//==============================================================
void setVoicePower(uint8_t status)
{
    myBMV31T001.setPower(status);
    // 0 = 關閉電源
    // 1 = 開啟電源
}

//==============================================================
// 控制指示燈
//==============================================================
void setVoiceLed(uint8_t status)
{
    myBMV31T001.setLED(status);
    // 0 = LED 滅
    // 1 = LED 亮
}

//==============================================================
// 播放單一數字語音
//==============================================================
void saynumber(int num)
{

    if (num < 0 || num > 9)
    {
        Serial.println("Wrong Number：僅允許 0~9 數字");
        return;
    }

    if (isPlaying())
        while (isPlaying()); // 若正在播放，等待結束

    while (!isPlaying())
    {
        play(voice_table[num]); // 播放對應數字語音
    }
}

//==============================================================
// 檢查是否為單一數字
//==============================================================
boolean checknum(String ss)
{
    String numberchar = "0123456789"; // 可接受的數字字元

    if (ss.length() != 1)
        return false;

    if (numberchar.indexOf(ss.charAt(0)) >= 0)
        return true; // 是數字
    else
        return false; // 非數字
}

//==============================================================
// 播放語音列表中指定的語音
//==============================================================
void sayText(uint8_t num)
{
    if (isPlaying())
        while (isPlaying()); // 等待播放結束

    while (!isPlaying())
    {
        play(voice_table[num]);
    }
}

//==============================================================
// 播放數字字串
//==============================================================
void SpeakStringNumber(String snum)
{
    if (snum.length() == 0)
        return; // 空字串不播放

    int le = snum.length();
    String cc;

    for (int i = 0; i < le; i++)
    {
        cc = snum.substring(i, i + 1); // 擷取單一字元

        if (checknum(cc))
        {
            saynumber(cc.toInt()); // 念出數字
        }
        else
        {
            if (cc == ".")
                sayText(VOC_11); // 念「點」
            if (cc == "-")
                sayText(VOC_12); // 念「負」
        }
    }
}

void sayTitle(uint8_t num)  //撥放語音開始公告音
{
    sayText(num) ;//撥放語音開始公告音
}

void saySensor(uint8_t num,String ss,uint8_t num2)  //撥放感測模組資料語音
{
    sayText(num) ;//撥放感測模組資料類別語音
    SpeakStringNumber(ss) ;// 感測器數值
    sayText(num2) ;//撥放感測模組資料單位語音
}

