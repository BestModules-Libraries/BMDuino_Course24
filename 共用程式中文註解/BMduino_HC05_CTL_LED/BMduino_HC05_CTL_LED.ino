/*************************************************
 * 檔案：        BMduino_HC05_CTL_LED.ino
 * 功能描述： 
 *   本程式搭配 BMDuino-UNO 開發板與 BMCOM2 擴充板，
 *   連接 HC-05 藍牙模組，實現藍牙通訊功能。
 *   主要功能：
 *   1. 從藍牙接收資料並即時顯示於序列埠監控視窗。
 *   2. 將序列埠監控視窗輸入的資料傳送至藍牙裝置。
 *   3. 根據接收到的特定指令控制板載 LED 燈開關。
 *   
 * 中文註解：      ChatGPT
 * 開發板：       BMDuino-UNO (相容於 Arduino UNO)
 *************************************************/

// ---------- 感測模組函式與外部函式引用宣告區 -----------
// 引用自訂的腳位初始化標頭檔，其中包含板載 LED 控制函式
#include "initPins.h"

// 引用 SoftwareSerial 函式庫，用於在非硬體序列埠腳位上模擬序列通訊
// 此函式庫允許我們使用任意數位腳位進行序列通訊
#include <SoftwareSerial.h>
// 若需使用硬體序列埠（如 Uno 的 0(RX)、1(TX)），可引入 HardwareSerial，但本例未使用

// ================================================================
// =============== 全域變數宣告區 (Global Variables) ===============
// ================================================================
// ================== 腳位設定 (請依 BMCOM2 實際接線調整) ==================
#define BT_RX_PIN 23   // Arduino 的接收腳位，接 HC-05 的 TX 腳（接收來自藍牙模組的資料）
#define BT_TX_PIN 24   // Arduino 的傳送腳位，接 HC-05 的 RX 腳（傳送資料至藍牙模組）

// ================================================================
// =============== 感測器物件實例化區 (Sensor Object) =============
// ================================================================
// 建立藍牙軟體序列埠物件，指定 RX 與 TX 腳位
// 此物件將用於與 HC-05 藍牙模組進行通訊
SoftwareSerial btSerial(BT_RX_PIN, BT_TX_PIN);

// ---------- 自定義函式宣告區 -----------
// 宣告函式：判斷接收到的資料並執行對應的控制命令
void judgeKeyCommand(unsigned char kk);

// ================== 初始化設定 (setup) ==================
// 此函式在 Arduino 啟動時執行一次，用於初始化設定
void setup()
{
  // 初始化硬體序列埠（USB 連接至電腦），鮑率設定為 9600
  // 此序列埠用於與電腦上的 Arduino IDE 序列埠監控視窗通訊
  Serial.begin(9600);
  
  // 初始化 HC-05 藍牙模組的軟體序列埠，鮑率設定為 9600（HC-05 預設值）
  btSerial.begin(9600);
  
  // 在序列埠監控視窗顯示啟動訊息，提示使用者程式已開始執行
  Serial.println("=== HC-05 Bluetooth Test ===");
  Serial.println("Waiting for Bluetooth data...");
}

// ================== 主迴圈，持續執行 (loop) ==================
// 此函式會不斷重複執行，為程式的主邏輯區
void loop()
{
  // ---------- 檢查藍牙序列埠是否有資料可讀 ----------
  // 判斷 HC-05 藍牙模組是否接收到資料
  if (btSerial.available())
  {
    // 當藍牙序列埠的接收緩衝區中有資料時，持續讀取直到清空緩衝區
    while(btSerial.available() > 0)
    {
      // 讀取一個位元組的資料（以無符號字元形式儲存）
      unsigned char btData = btSerial.read();
      
      // 將讀取到的資料轉為字元形式，顯示於序列埠監控視窗
      Serial.print(char(btData));   // 以可視字元形式印出
      
      // 呼叫自訂函式，根據接收到的資料執行對應控制命令（如控制 LED）
      judgeKeyCommand(btData);
      
      // 註解：亦可使用以下方式直接寫入原始位元組資料（不進行字元轉換）：
      // Serial.write(btData);
    }
  }

  // ---------- （可選功能）轉發電腦序列埠資料至藍牙裝置 ----------
  // 若序列埠監控視窗有輸入資料，則將其轉發至藍牙裝置
  if (Serial.available())
  {
    // 讀取電腦序列埠監控視窗輸入的一個位元組資料
    unsigned char pcData = Serial.read();
    
    // 將該資料透過藍牙序列埠傳送至 HC-05（再傳至配對的藍牙裝置）
    btSerial.write(pcData);
  }
}

// ================== 自訂函式：判斷指令並執行對應動作 ==================
// 參數：kk - 接收到的無符號字元資料
void judgeKeyCommand(unsigned char kk)
{
  // 若接收到的資料為 0x4f（對應字元 'O'，代表關閉 LED）
  if (kk == 0x4f)
    {
        // 在序列埠監控視窗顯示執行動作
        Serial.println("設定LEDPin的低電位，關閉LED");
        
        // 呼叫函式關閉板載 LED（位於腳位 13）
        TurnOffLed13();
    }
    
  // 若接收到的資料為 0x50（對應字元 'P'，代表開啟 LED）
  if (kk == 0x50)
    {
        // 在序列埠監控視窗顯示執行動作
        Serial.println("設定LEDPin的高電位，開啟LED");
        
        // 呼叫函式開啟板載 LED（位於腳位 13）
        TurnOnLed13();
    }    
}