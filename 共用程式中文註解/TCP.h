// ================================================================
// 檔案名稱：TCP.h
// 描述：WiFi 網路通訊函式庫
// 功能：提供 BMC81M001 WiFi 模組的控制函式，包含連線、IP 取得、網路設定等
//       用於建立 WiFi 連線並取得網路相關資訊
// ================================================================

// ================================================================
// =============== 前置處理指令區 ===============
// ================================================================

// 防止標頭檔重複引入的保護機制
// 如果未定義 _BMC81M001_H__，則定義它並編譯後續程式碼
#ifndef _BMC81M001_H__
#define _BMC81M001_H__

// ================================================================
// =============== 函式庫引入區 ===============
// ================================================================

// 引入 BMC81M001 WiFi 模組控制函式庫（硬體控制核心）
#include "BMC81M001.h"

// 引入字串處理函式庫（Arduino 已預設包含，此處為明確宣告）
#include <String.h>

// ================================================================
// =============== WiFi 連線設定常數區 ===============
// ================================================================

// WiFi 熱點連線設定（根據實際網路環境修改）
#define WIFI_SSID "NCNUIOT"        // 要連接的 WiFi 網路名稱（SSID）
#define WIFI_PASS "0123456789"     // WiFi 密碼（根據實際密碼修改）

// ================================================================
// =============== 硬體腳位定義區 ===============
// ================================================================

// 內建 LED 腳位定義（通常用於狀態指示）
int LED = 13;   // Arduino UNO 內建 LED 接在 D13 腳位
                // 其他開發板可能需要調整

// ================================================================
// =============== 全域常數與變數宣告區 ===============
// ================================================================

#define DEB_CNT     50                // 除錯延遲時間（毫秒）
                                       // 用於等待模組回應或狀態穩定

#define RES_MAX_LENGTH 200           // 串列通訊接收緩衝區最大長度
                                       // 根據 WiFi 模組回應長度設定

char  SerialBuff[RES_MAX_LENGTH];   // 串列通訊接收資料緩衝區
                                       // 用於暫存從 WiFi 模組接收的原始資料

char  data[30];                     // 關鍵資料暫存緩衝區
                                       // 用於儲存解析後的特定資料（如 IP、MAC）

int   resLen;                       // 接收資料的實際長度
                                       // 記錄 SerialBuff 中有效資料的長度

int   nKeyBuf;                      // 關鍵資料緩衝處理指標
                                       // 用於追蹤資料解析位置

String DATA_BUF;                   // 暫存資料用的動態字串變數
                                       // 用於字串操作和資料暫存

String tcpBuff;                    // TCP 通訊資料緩衝字串
                                       // 用於儲存要傳送的 TCP 資料或接收的資料

// 結束標頭檔保護區（與開頭的 #ifndef 對應）
#endif

// ================================================================
// =============== WiFi 物件實例化區 ===============
// ================================================================

/*
建立 BMC81M001 WiFi 模組控制物件，命名為 Wifi
通訊介面選擇（根據硬體接線選擇其中之一）：

注意：只能啟用其中一種通訊方式
*/

// 選項1：使用軟體序列埠（需指定 RX, TX 腳位）
// BMC81M001 Wifi(6, 7);  // RX 接腳 6，TX 接腳 7

// 選項2：使用硬體 Serial1（部分 Arduino 板子支援）
// BMC81M001 Wifi(&Serial1);  // 使用 Serial1 硬體序列埠

// 選項3：使用硬體 Serial2（BMduino 開發板專用，本程式選用）
BMC81M001 Wifi(&Serial2);  // 使用 BMduino 的 Serial2 硬體序列埠
                            // 通常對應特定的 RX2, TX2 腳位

// ================================================================
// =============== 函式宣告區 ===============
// ================================================================

// ---------- WiFi 初始化和控制函式 ----------
void initWiFi();        // 初始化 WiFi 模組並連線到指定熱點

// ---------- 網路資訊取得函式 ----------
String GetMAC();        // 取得 WiFi 模組的 MAC 位址（硬體唯一識別碼）
String GetSSID();       // 取得目前連線的 WiFi 熱點名稱
String GetIP();         // 取得由 DHCP 分配的 IP 位址
String GetGateWay();    // 取得閘道器（路由器）IP 位址
String GetsubMask();    // 取得子網路遮罩（Subnet Mask）
String ScanAP();        // 掃描附近可用的 WiFi 熱點

// ================================================================
// =============== 函式實作區 ===============
// ================================================================

// ---------------------------------------------------------------
// 函式名稱：initWiFi()
// 功能：初始化 WiFi 模組並連線到指定的無線網路熱點
// 參數：無
// 傳回值：無
// 流程：
//   1. 啟動 WiFi 模組
//   2. 重設模組到初始狀態
//   3. 嘗試連線到指定 SSID
//   4. 顯示連線結果
// ---------------------------------------------------------------
void initWiFi()
{
    // 步驟1：啟動 WiFi 模組
    // begin() 函式會初始化模組的內部設定和序列通訊
    Wifi.begin();
    
    // 步驟2：重設 WiFi 模組
    // reset() 確保模組處於乾淨的初始狀態
    // 清除所有先前的連線設定和暫存資料
    Wifi.reset();
    
    // 步驟3：等待模組重設完成
    // 延遲 1000ms（1秒），確保模組完全啟動
    delay(1000);
    
    // 步驟4：顯示初始化訊息（注意："WFIF" 應為 "WIFI"）
    Serial.print("init WFIF：");  // 應修正為 "init WIFI:"
    
    // 步驟5：嘗試連線到指定的 WiFi 熱點
    // connectToAP() 參數：SSID（網路名稱）、PASS（密碼）
    // 回傳 true：連線成功，false：連線失敗
    if (!Wifi.connectToAP(WIFI_SSID, WIFI_PASS)) {
        // 連線失敗情況處理
        Serial.print("WIFI fail,");
        // 可能原因：
        // 1. SSID 不存在或訊號太弱
        // 2. 密碼錯誤
        // 3. DHCP 無法取得 IP
        // 4. 硬體連線問題
    } else {
        // 連線成功情況處理
        Serial.print("WIFI success,");
        // 此時模組已：
        // 1. 完成無線認證
        // 2. 取得 DHCP 分配的 IP
        // 3. 設定好 DNS 等網路參數
    }
    
    // 步驟6：額外等待時間，確保網路連線穩定
    // 給路由器足夠時間完成 DHCP 和路由設定
    delay(500);
}

// ---------------------------------------------------------------
// 函式名稱：GetMAC()
// 功能：取得 WiFi 模組的 MAC 位址（硬體唯一識別碼）
// 參數：無
// 傳回值：String - MAC 位址字串（格式如：D8:BF:C0:12:34:56）
// 說明：MAC 位址是網路卡在出廠時設定的唯一識別碼
// ---------------------------------------------------------------
String GetMAC()
{
    // 步驟1：等待模組穩定
    // 避免在前一個指令執行後立即讀取造成錯誤
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：從 WiFi 模組讀取 MAC 位址
    // getMacAddress() 會傳回 MAC 位址字串
    tmp = Wifi.getMacAddress();
    
    // 步驟4：將字串轉換為大寫格式
    // 統一顯示格式，方便閱讀和比較
    tmp.toUpperCase();
    
    // 步驟5：回傳 MAC 位址字串
    return tmp;
}

// ---------------------------------------------------------------
// 函式名稱：GetSSID()
// 功能：取得目前連線的 WiFi 熱點名稱（SSID）
// 參數：無
// 傳回值：String - SSID 名稱（若未連線則回傳空字串）
// 說明：SSID 是無線網路的廣播名稱
// ---------------------------------------------------------------
String GetSSID()
{
    // 步驟1：等待模組穩定回應
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：檢查 WiFi 連線狀態
    // getStatus() 回傳 true：已連線，false：未連線
    if (Wifi.getStatus()) {
        // 已連線狀態：讀取 SSID
        tmp = Wifi.getSSID();
        
        // 將 SSID 轉為大寫格式（統一顯示）
        tmp.toUpperCase();
    } else {
        // 未連線狀態：回傳空字串
        tmp = "";
    }
    
    // 步驟4：回傳 SSID 或空字串
    return tmp;
}

// ---------------------------------------------------------------
// 函式名稱：GetIP()
// 功能：取得 WiFi 連線後由 DHCP 分配的 IP 位址
// 參數：無
// 傳回值：String - IP 位址（格式如：192.168.1.105）
//                 若未連線則回傳空字串
// 說明：IP 位址用於網路中的裝置識別和通訊
// ---------------------------------------------------------------
String GetIP()
{
    // 步驟1：等待模組穩定
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：檢查 WiFi 連線狀態
    if (Wifi.getStatus()) {
        // 已連線狀態：讀取 IP 位址
        tmp = Wifi.getIP();
        
        // 轉為大寫格式（雖然 IP 沒有大小寫區別）
        tmp.toUpperCase();
    } else {
        // 未連線狀態：回傳空字串
        tmp = "";
    }
    
    // 步驟4：回傳 IP 位址或空字串
    return tmp;
}

// ---------------------------------------------------------------
// 函式名稱：GetGateWay()
// 功能：取得閘道器（路由器）的 IP 位址
// 參數：無
// 傳回值：String - 閘道器 IP 位址（如：192.168.1.1）
//                 若未連線則回傳空字串
// 說明：閘道器是連接本地網路和外部網路的裝置
// ---------------------------------------------------------------
String GetGateWay()
{
    // 步驟1：等待模組穩定
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：檢查 WiFi 連線狀態
    if (Wifi.getStatus()) {
        // 已連線狀態：讀取閘道器 IP
        tmp = Wifi.getGateway();
        
        // 轉為大寫格式
        tmp.toUpperCase();
    } else {
        // 未連線狀態：回傳空字串
        tmp = "";
    }
    
    // 步驟4：回傳閘道器 IP 或空字串
    return tmp;
}

// ---------------------------------------------------------------
// 函式名稱：GetsubMask()
// 功能：取得子網路遮罩（Subnet Mask）
// 參數：無
// 傳回值：String - 子網路遮罩（如：255.255.255.0）
//                 若未連線則回傳空字串
// 說明：子網路遮罩用於劃分 IP 位址的網路部分和主機部分
// ---------------------------------------------------------------
String GetsubMask()
{
    // 步驟1：等待模組穩定
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：檢查 WiFi 連線狀態
    if (Wifi.getStatus()) {
        // 已連線狀態：讀取子網路遮罩
        tmp = Wifi.getMask();
        
        // 轉為大寫格式
        tmp.toUpperCase();
    } else {
        // 未連線狀態：回傳空字串
        tmp = "";
    }
    
    // 步驟4：回傳子網路遮罩或空字串
    return tmp;
}

// ---------------------------------------------------------------
// 函式名稱：ScanAP()
// 功能：掃描附近可用的 WiFi 熱點（無線網路）
// 參數：無
// 傳回值：String - 掃描到的熱點列表（字串格式）
//                 若掃描失敗則回傳空字串
// 說明：用於偵測環境中的無線網路，可幫助選擇要連接的熱點
// ---------------------------------------------------------------
String ScanAP()
{
    // 步驟1：等待模組穩定
    delay(500);
    
    // 步驟2：建立暫存字串變數
    String tmp = "";
    
    // 步驟3：檢查 WiFi 模組是否可運作
    // 注意：掃描功能不一定需要已連線狀態
    if (Wifi.getStatus()) {
        // 模組可運作：執行熱點掃描
        // SSID() 函式可能傳回掃描結果字串
        // （實際函式名稱可能需確認，通常為 scan() 或類似）
        tmp = Wifi.SSID();
        
        // 轉為大寫格式
        tmp.toUpperCase();
    } else {
        // 模組無法運作：回傳空字串
        tmp = "";
    }
    
    // 步驟4：回傳掃描結果或空字串
    return tmp;
}

// ================================================================
// ===================== 使用注意事項 ============================
// ================================================================
/*
重要提醒：

1. WiFi 設定修改：
   - 必須修改 WIFI_SSID 和 WIFI_PASS 為您的實際網路設定
   - 確保密碼正確且網路可用
   - 考慮將敏感資訊移到設定檔或使用輸入方式

2. 硬體接線：
   - 確認 WiFi 模組的 TX/RX 與 Arduino 正確交叉連接
   - 檢查電源供應是否穩定（通常需要 3.3V 或 5V）
   - 注意序列埠電壓位準是否匹配（可能需要電位轉換）

3. 序列埠選擇：
   - Serial2 通常對應特定硬體腳位（BMduino 開發板）
   - 其他開發板可能需要調整為 Serial 或 Serial1
   - 軟體序列埠（SoftwareSerial）可能不穩定，建議用硬體序列埠

4. 連線失敗處理：
   - 目前程式在連線失敗時僅顯示訊息
   - 可加入重試機制（例如重試 3 次）
   - 可實現自動切換備用熱點功能

5. 延遲時間調整：
   - 各函式的 delay(500) 可根據實際模組響應速度調整
   - 太快讀取可能得到不完整資料
   - 太慢會影響系統響應速度

6. 記憶體使用：
   - String 物件使用動態記憶體，可能造成記憶體碎片
   - 大量使用時可考慮使用 char 陣列
   - 監控 Arduino 的 RAM 使用量

7. 錯誤處理強化：
   - 可加入連線逾時機制
   - 檢查訊號強度（RSSI）
   - 實作斷線自動重連功能

8. 安全考量：
   - 避免在程式碼中寫死密碼（特別是要公開的程式碼）
   - 考慮使用 WPA2 加密的網路
   - 生產環境應使用更安全的連線方式

9. 多網路環境：
   - 可實作多組 SSID/PASS 設定
   - 優先連接訊號強的熱點
   - 記憶常用網路設定

10. 功耗考量：
    - WiFi 連線消耗較多電力
    - 可實作睡眠模式節省電力
    - 非必要時可斷開 WiFi 連線
*/