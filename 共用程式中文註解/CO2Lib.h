/*
//二氧化碳偵測模組(BMCOM) BME58M332 獨立模組

************************************************
File: readCO2Concentration.ino
Description: 讀取二氧化碳濃度（CO2 concentration），單位為 ppm
Note: 使用 BM25S3321-1 CO2 感測模組搭配 BMduino-UNO

【程式功能摘要（加強說明）】
模組 / 函式                功能說明
-----------------------------------------------------------
BM25S3321-1.h      CO2 感測器函式庫，負責 UART 封包解析
CO2.begin()        初始化 UART / 感測模組
preheatCountdown() 必要的預熱程序（約 60 秒）
setRangeMax()      設定 CO2 最大量測範圍（2000 / 5000 ppm）
readCO2Value()     回傳解析後的 CO2 濃度（ppm）
************************************************
*/
//------外部引入函式區--------------------------
#include <BM25S3321-1.h>
//---------------------------------------------------------------
// 匯入 BestModules 官方的 BM25S3321-1 CO2 感測器函式庫
// 此模組以 UART（序列埠）方式回傳 CO2 濃度值
// UART 速度固定為 9600 bps，回傳資料為已封裝好的協議格式。
//---------------------------------------------------------------

//------全域變數區--------------------------
#define STA_PIN 22  
// STA_PIN（狀態腳位）
// 此腳位由感測器模組輸出，用來顯示模組狀態（例如熱機中、量測中）
// 在 BMduino 上可選擇任意可用 GPIO

// 若使用 SoftwareSerial，可開啟下列腳位
// #define RX_PIN 2   // CO2 Sensor → Arduino（資料輸入腳）
// #define TX_PIN 3   // Arduino → CO2 Sensor（資料輸出腳）

uint16_t CO2Value = 0;
// 儲存 CO2 濃度的變數
// uint16_t → 0~65535，足夠存放 0~5000 ppm

//-------------  end of 全域變數 ------------------


//-----------------感測元件物件區-------------------------
/*-------------------------------------------------------------
   建立 CO2 感測模組物件
   感測器支援硬體序列埠與軟體序列埠
--------------------------------------------------------------*/

// ▼ 軟體序列埠（SoftwareSerial）示範：
// BM25S3321_1 CO2(STA_PIN, RX_PIN, TX_PIN);

// ▼ 硬體序列埠（HardwareSerial）示範：
// BM25S3321_1 CO2(STA_PIN, &Serial);    // 使用主序列埠（不建議）
// BM25S3321_1 CO2(STA_PIN, &Serial2);
// BM25S3321_1 CO2(STA_PIN, &Serial3);
// BM25S3321_1 CO2(STA_PIN, &Serial4);

// → 本程式採用 Serial1（BMduino-UNO 具備多組 UART）
BM25S3321_1 CO2(STA_PIN, &Serial1);


/*-------------------------------------------------------------
   自訂函式宣告
--------------------------------------------------------------*/
void initCO2();        // 初始化 CO2 模組
uint16_t readCO2();    // 讀取 CO2 ppm 數值



/*-------------------------------------------------------------
   自訂函式：初始化二氧化碳感測模組
   功能：啟動 UART、執行預熱、設定量測範圍
--------------------------------------------------------------*/
void initCO2()
{
    CO2.begin();  
    // --------------------------------------------------------
    // 初始化感測模組（設定 UART、進行基本檢查）
    // begin() 會自動設定感測器與序列埠溝通的波特率：9600 bps
    // --------------------------------------------------------

    Serial.println("Module preheating...(about 60 seconds)");
    
    /*
     * ➤ 為何需要預熱？
     * CO2 感測器採用 NDIR（Non-Dispersive Infrared，非分散式紅外線）原理，
     * 內部有紅外線光源與感測元件。為確保光源穩定、量測準確，
     * 必須進行約 60 秒的預熱程序。
     *
     * 若不預熱 → 初期數據會「偏低」或「跳動」。
     */

    CO2.preheatCountdown();  
    // --------------------------------------------------------
    // 執行內建的預熱倒數程序
    // 此函式會阻塞程式約 60 秒，不需要手動寫 delay()
    // --------------------------------------------------------

    Serial.println("End of module preheating.\n");
    Serial.println("Perform initial setup.");


    /*
     *（選用）零點校正
     * 必須在純淨戶外空氣（約 400 ppm CO2）條件下進行
     * 若誤按校正 → 感測器量測可能嚴重偏差，因此預設關閉
     */
    // CO2.calibrateZeroPoint();


    CO2.setRangeMax(5000);
    /*
     * 設定最大可量測範圍
     *  2000 ppm → 精度較高，適合室內空調環境
     *  5000 ppm → 標準室內通用範圍
     *
     * setRangeMax(5000) 代表模組量測範圍為 0 ~ 5000 ppm
     */
}



/*-------------------------------------------------------------
   自訂函式：讀取 CO2 濃度（ppm）
--------------------------------------------------------------*/
uint16_t readCO2()
{
    /*
     * readCO2Value() 流程：
     * --------------------------------------------------------
     * 1. 函式向感測器傳送查詢指令
     * 2. 感測器回傳「固定格式 UART 封包」
     * 3. 函式解析封包中的 CO2 ppm 資料
     * 4. 回傳整數（ppm）
     * --------------------------------------------------------
     */

    return CO2.readCO2Value();
}
